#include "st7789_display.h"
#include <string.h>
#include <stdio.h>

// Complete 8x8 font (bitmap) - ASCII characters 32-126
static const uint8_t font8x8[128][8] = {
    // Control characters (0-31) - not used
    [0 ... 31] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    // Printable characters start at 32 (space)
    [32] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Space
    [33] = {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00}, // !
    [34] = {0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
    [35] = {0x66, 0x66, 0xFF, 0x66, 0xFF, 0x66, 0x66, 0x00}, // #
    [36] = {0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00}, // $
    [37] = {0x62, 0x66, 0x0C, 0x18, 0x30, 0x66, 0x46, 0x00}, // %
    [38] = {0x3C, 0x66, 0x3C, 0x38, 0x67, 0x66, 0x3F, 0x00}, // &
    [39] = {0x06, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
    [40] = {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00}, // (
    [41] = {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00}, // )
    [42] = {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00}, // *
    [43] = {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00}, // +
    [44] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30}, // ,
    [45] = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00}, // -
    [46] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00}, // .
    [47] = {0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00}, // /
    
    // Numbers 0-9
    [48] = {0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00}, // 0
    [49] = {0x18, 0x18, 0x38, 0x18, 0x18, 0x18, 0x7E, 0x00}, // 1
    [50] = {0x3C, 0x66, 0x06, 0x0C, 0x30, 0x60, 0x7E, 0x00}, // 2
    [51] = {0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00}, // 3
    [52] = {0x06, 0x0E, 0x1E, 0x66, 0x7F, 0x06, 0x06, 0x00}, // 4
    [53] = {0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00}, // 5
    [54] = {0x3C, 0x66, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00}, // 6
    [55] = {0x7E, 0x66, 0x0C, 0x18, 0x18, 0x18, 0x18, 0x00}, // 7
    [56] = {0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00}, // 8
    [57] = {0x3C, 0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C, 0x00}, // 9
    
    // Special characters
    [58] = {0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x00}, // :
    [59] = {0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30}, // ;
    [60] = {0x0E, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0E, 0x00}, // <
    [61] = {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00}, // =
    [62] = {0x70, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x70, 0x00}, // >
    [63] = {0x3C, 0x66, 0x06, 0x0C, 0x18, 0x00, 0x18, 0x00}, // ?
    [64] = {0x3C, 0x66, 0x6E, 0x6E, 0x60, 0x62, 0x3C, 0x00}, // @
    
    // Uppercase letters A-Z
    [65] = {0x18, 0x3C, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00}, // A
    [66] = {0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00}, // B
    [67] = {0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00}, // C
    [68] = {0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00}, // D
    [69] = {0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7E, 0x00}, // E
    [70] = {0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00}, // F
    [71] = {0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00}, // G
    [72] = {0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00}, // H
    [73] = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // I
    [74] = {0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x6C, 0x38, 0x00}, // J
    [75] = {0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00}, // K
    [76] = {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00}, // L
    [77] = {0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00}, // M
    [78] = {0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x00}, // N
    [79] = {0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00}, // O
    [80] = {0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00}, // P
    [81] = {0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x0E, 0x00}, // Q
    [82] = {0x7C, 0x66, 0x66, 0x7C, 0x78, 0x6C, 0x66, 0x00}, // R
    [83] = {0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00}, // S
    [84] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00}, // T
    [85] = {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00}, // U
    [86] = {0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00}, // V
    [87] = {0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00}, // W
    [88] = {0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00}, // X
    [89] = {0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00}, // Y
    [90] = {0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00}, // Z
    
    // Special characters
    [91] = {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00}, // [
    [92] = {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00}, // \
    [93] = {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00}, // ]
    [94] = {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00}, // ^
    [95] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF}, // _
    [96] = {0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00}, // `
    
    // Lowercase letters a-z (simplified, same as uppercase for this basic font)
    [97]  = {0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E, 0x00}, // a
    [98]  = {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00}, // b
    [99]  = {0x00, 0x00, 0x3C, 0x60, 0x60, 0x60, 0x3C, 0x00}, // c
    [100] = {0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00}, // d
    [101] = {0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00}, // e
    [102] = {0x0E, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x00}, // f
    [103] = {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x7C}, // g
    [104] = {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00}, // h
    [105] = {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00}, // i
    [106] = {0x06, 0x00, 0x0E, 0x06, 0x06, 0x06, 0x66, 0x3C}, // j
    [107] = {0x60, 0x60, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x00}, // k
    [108] = {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // l
    [109] = {0x00, 0x00, 0x66, 0x7F, 0x7F, 0x6B, 0x63, 0x00}, // m
    [110] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00}, // n
    [111] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00}, // o
    [112] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60}, // p
    [113] = {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06}, // q
    [114] = {0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x00}, // r
    [115] = {0x00, 0x00, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x00}, // s
    [116] = {0x18, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x0E, 0x00}, // t
    [117] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00}, // u
    [118] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00}, // v
    [119] = {0x00, 0x00, 0x63, 0x6B, 0x7F, 0x3E, 0x36, 0x00}, // w
    [120] = {0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x00}, // x
    [121] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3E, 0x0C, 0x78}, // y
    [122] = {0x00, 0x00, 0x7E, 0x0C, 0x18, 0x30, 0x7E, 0x00}, // z
    
    // Final characters
    [123] = {0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00}, // {
    [124] = {0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00}, // |
    [125] = {0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00}, // }
    [126] = {0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // ~
    [127] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // DEL
};

void st7789_init(void) {
    // Initialize SPI
    spi_init(SPI_PORT, 24000 * 1000); 
    
    // Set up SPI pins
    gpio_set_function(PIN_MOSI, GPIO_FUNC_SPI);
    gpio_set_function(PIN_SCK, GPIO_FUNC_SPI);
    
    // Set up control pins
    gpio_init(PIN_CS);
    gpio_init(PIN_DC);
    gpio_init(PIN_RST);
    
    gpio_set_dir(PIN_CS, GPIO_OUT);
    gpio_set_dir(PIN_DC, GPIO_OUT);
    gpio_set_dir(PIN_RST, GPIO_OUT);
    
    // Initial pin states
    gpio_put(PIN_CS, 1);   // CS high (inactive)
    gpio_put(PIN_DC, 0);   // DC low
    gpio_put(PIN_RST, 1);  // RST high
    
    printf("Fazendo reset do display...\n");
    // Reset sequence
    gpio_put(PIN_RST, 0);
    sleep_ms(10);  // Reduzido de 50ms
    gpio_put(PIN_RST, 1);
    sleep_ms(50);  // Reduzido de 200ms
    
    printf("Enviando comandos de inicialização...\n");
    // Initialize ST7789
    st7789_write_cmd(ST7789_SWRESET);  // Software reset
    sleep_ms(50);  // Reduzido de 200ms
    
    st7789_write_cmd(ST7789_SLPOUT);   // Sleep out
    sleep_ms(50);  // Reduzido de 200ms
    
    st7789_write_cmd(ST7789_COLMOD);   // Set color mode
    st7789_write_data(0x55);           // 16-bit color (RGB565)
    
    st7789_write_cmd(ST7789_MADCTL);   // Memory access control
    st7789_write_data(0x00);           // Default orientation
    
    st7789_write_cmd(ST7789_INVON);    // Display inversion on (fixes color inversion)
    
    st7789_write_cmd(ST7789_CASET);    // Column address set
    st7789_write_data(0x00);
    st7789_write_data(0x00);
    st7789_write_data(0x00);
    st7789_write_data(0xEF);           // 239 (240-1)
    
    st7789_write_cmd(ST7789_RASET);    // Row address set  
    st7789_write_data(0x00);
    st7789_write_data(0x00);
    st7789_write_data(0x01);
    st7789_write_data(0x3F);           // 319 (320-1)
    
    st7789_write_cmd(ST7789_DISPON);   // Display on
    sleep_ms(20);  // Reduzido de 200ms
    
    printf("Display ST7789 inicializado com sucesso!\n");
    
    // Clear screen to black
    printf("Limpando tela...\n");
    st7789_fill_color(BLACK);
}

void st7789_write_cmd(uint8_t cmd) {
    gpio_put(PIN_CS, 0);
    gpio_put(PIN_DC, 0);  // Command mode
    spi_write_blocking(SPI_PORT, &cmd, 1);
    gpio_put(PIN_CS, 1);
}

void st7789_write_data(uint8_t data) {
    gpio_put(PIN_CS, 0);
    gpio_put(PIN_DC, 1);  // Data mode
    spi_write_blocking(SPI_PORT, &data, 1);
    gpio_put(PIN_CS, 1);
}

void st7789_write_data16(uint16_t data) {
    uint8_t buffer[2];
    buffer[0] = (data >> 8) & 0xFF;  // High byte
    buffer[1] = data & 0xFF;         // Low byte
    
    gpio_put(PIN_CS, 0);
    gpio_put(PIN_DC, 1);  // Data mode
    spi_write_blocking(SPI_PORT, buffer, 2);
    gpio_put(PIN_CS, 1);
}

void st7789_set_window(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1) {
    st7789_write_cmd(ST7789_CASET);  // Column address set
    st7789_write_data(x0 >> 8);
    st7789_write_data(x0 & 0xFF);
    st7789_write_data(x1 >> 8);
    st7789_write_data(x1 & 0xFF);
    
    st7789_write_cmd(ST7789_RASET);  // Row address set
    st7789_write_data(y0 >> 8);
    st7789_write_data(y0 & 0xFF);
    st7789_write_data(y1 >> 8);
    st7789_write_data(y1 & 0xFF);
    
    st7789_write_cmd(ST7789_RAMWR);  // Write to RAM
}

void st7789_fill_color(uint16_t color) {
    st7789_set_window(0, 0, DISPLAY_WIDTH - 1, DISPLAY_HEIGHT - 1);
    
    gpio_put(PIN_CS, 0);
    gpio_put(PIN_DC, 1);  // Data mode
    
    uint8_t buffer[2];
    buffer[0] = (color >> 8) & 0xFF;
    buffer[1] = color & 0xFF;
    
    for (uint32_t i = 0; i < DISPLAY_WIDTH * DISPLAY_HEIGHT; i++) {
        spi_write_blocking(SPI_PORT, buffer, 2);
    }
    
    gpio_put(PIN_CS, 1);
}

void st7789_draw_pixel(uint16_t x, uint16_t y, uint16_t color) {
    if (x >= DISPLAY_WIDTH || y >= DISPLAY_HEIGHT) return;
    
    st7789_set_window(x, y, x, y);
    st7789_write_data16(color);
}

void st7789_draw_char(uint16_t x, uint16_t y, char c, uint16_t color, uint16_t bg_color) {
    if (x >= DISPLAY_WIDTH - 8 || y >= DISPLAY_HEIGHT - 8) return;
    if (c < 0 || c > 127) return;
    
    st7789_set_window(x, y, x + 7, y + 7);
    
    gpio_put(PIN_CS, 0);
    gpio_put(PIN_DC, 1);  // Data mode
    
    for (int row = 0; row < 8; row++) {
        uint8_t line = font8x8[(int)c][row];
        for (int col = 0; col < 8; col++) {
            uint16_t pixel_color = (line & (0x80 >> col)) ? color : bg_color;
            uint8_t buffer[2];
            buffer[0] = (pixel_color >> 8) & 0xFF;
            buffer[1] = pixel_color & 0xFF;
            spi_write_blocking(SPI_PORT, buffer, 2);
        }
    }
    
    gpio_put(PIN_CS, 1);
}

// Draw a filled rectangle
void st7789_fill_rect(uint16_t x, uint16_t y, uint16_t width, uint16_t height, uint16_t color) {
    if (x >= DISPLAY_WIDTH || y >= DISPLAY_HEIGHT) return;
    
    // Limit to display boundaries
    if (x + width > DISPLAY_WIDTH) width = DISPLAY_WIDTH - x;
    if (y + height > DISPLAY_HEIGHT) height = DISPLAY_HEIGHT - y;
    
    st7789_set_window(x, y, x + width - 1, y + height - 1);
    
    gpio_put(PIN_CS, 0);
    gpio_put(PIN_DC, 1);  // Data mode
    
    uint8_t buffer[2];
    buffer[0] = (color >> 8) & 0xFF;
    buffer[1] = color & 0xFF;
    
    for (uint32_t i = 0; i < width * height; i++) {
        spi_write_blocking(SPI_PORT, buffer, 2);
    }
    
    gpio_put(PIN_CS, 1);
}

void st7789_draw_string(uint16_t x, uint16_t y, const char* str, uint16_t color, uint16_t bg_color) {
    uint16_t start_x = x;
    uint16_t current_x = x;
    uint16_t current_y = y;
    
    // First, calculate the area needed and clear it
    int str_len = strlen(str);
    int lines = 1;
    for (int i = 0; i < str_len; i++) {
        if (str[i] == '\n') lines++;
    }
    
    // Clear the background area first
    st7789_fill_rect(x, y, str_len * 8, lines * 8, bg_color);
    
    // Now draw each character
    while (*str) {
        if (*str == '\n') {
            current_y += 8;
            current_x = start_x;
        } else {
            if (current_x >= DISPLAY_WIDTH - 8) {
                current_y += 8;
                current_x = start_x;
            }
            
            // Only draw the character pixels (not the background)
            if (current_x < DISPLAY_WIDTH && current_y < DISPLAY_HEIGHT) {
                // Draw character without background (background already cleared)
                st7789_set_window(current_x, current_y, current_x + 7, current_y + 7);
                
                gpio_put(PIN_CS, 0);
                gpio_put(PIN_DC, 1);  // Data mode
                
                for (int row = 0; row < 8; row++) {
                    uint8_t line = font8x8[(uint8_t)(*str)][row];
                    for (int col = 0; col < 8; col++) {
                        uint16_t pixel_color;
                        if (line & (0x80 >> col)) {
                            pixel_color = color;  // Foreground
                        } else {
                            pixel_color = bg_color;  // Background
                        }
                        
                        uint8_t buffer[2];
                        buffer[0] = (pixel_color >> 8) & 0xFF;
                        buffer[1] = pixel_color & 0xFF;
                        spi_write_blocking(SPI_PORT, buffer, 2);
                    }
                }
                
                gpio_put(PIN_CS, 1);
            }
            
            current_x += 8;
        }
        str++;
    }
}